@page "/einstein"
@using Agentic.GraphRag.Application.EinsteinQuery.Interfaces
@using Agentic.GraphRag.Application.EinsteinQuery
@using Agentic.GraphRag.Components
@rendermode InteractiveServer
@inject IEinsteinDataIngestionService IngestionService
@inject IEinsteinQueryService QueryService
@inject EinsteinState State

<PageTitle>Einstein Chat</PageTitle>

<h1>Ask About Einstein</h1>
<p>This component queries a knowledge source for Einstein facts.</p>

<div class="chat-panel">
    <div class="load-section">
        <button id="loadData" name="loadData"
                aria-label="Load Einstein data"
                @onclick="LoadData" disabled="@State.IsLoading">
            Load
        </button>
    </div>

    <div class="qa-list">
        @if (!State.HasHistory)
        {
            <p>Ask a question about Albert Einstein (e.g. "When was Einstein born?")</p>
        }
        else
        {
            @foreach (var item in State.History)
            {
                <div class="q"><strong>You:</strong> @item.Question</div>
                <div class="a">
                    <strong>Rewritten Query:</strong> @item.Answer.RewrittenQuery<br />
                    <strong>Standard Response:</strong> @item.Answer.StandardResponse<br />

                    <details open>
                        <summary>Standard Search Results</summary>
                        <ul>
                            @foreach (var result in item.Answer.StandardSearchResults)
                            {
                                <li>@result</li>
                            }
                        </ul>
                    </details>

                    <strong>Step Back Response:</strong> @item.Answer.StepBackResponse<br />

                    <details>
                        <summary>Step Back Search Results</summary>
                        <ul>
                            @foreach (var result in item.Answer.StepBackSearchResults)
                            {
                                <li>
                                    @result.Text
                                    <span class="@(result.Score > 0.9 ? "score-high" : result.Score > 0.5 ? "score-medium" : "score-low")">
                                        (Score: @result.Score:F2)
                                    </span>
                                </li>
                            }
                        </ul>
                    </details>
                </div>
            }
        }
    </div>
    <div class="input-row">
        <input placeholder="Type your question..."
               @bind="State.CurrentQuestion"
               @bind:event="oninput"
               @onkeydown="HandleKeyDown" />
        <button id="askEinstein" name="askEinstein"
                aria-label="Ask Einstein"
                @onclick="Ask"
                disabled="@(State.IsLoading || string.IsNullOrWhiteSpace(State.CurrentQuestion))">
            Ask
        </button>
        @if (State.HasHistory)
        {
            <button class="btn btn-link" @onclick="ClearAsync" aria-label="Clear conversation history" disabled="@State.IsLoading">Clear</button>
        }
    </div>
</div>

@code {
    private async Task Ask()
    {
        if (string.IsNullOrWhiteSpace(State.CurrentQuestion)) return;
        var question = State.CurrentQuestion;
        State.SetLoading(true);
        try
        {
            var answer = await QueryService.Ask(question);
            State.AddExchange(question, answer);
            State.CurrentQuestion = string.Empty;
        }
        finally
        {
            State.SetLoading(false);
        }
    }

    private async Task LoadData()
    {
        State.SetLoading(true);
        try
        {
            await IngestionService.LoadData();
        }
        finally
        {
            State.SetLoading(false);
        }
    }

    private Task ClearAsync()
    {
        State.Clear();
        return Task.CompletedTask;
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await Ask();
        }
    }
}
